# This cloudbuild.yaml is used to test run a full integration test against a
# running Zipkin instance.
steps:
  - name: gcr.io/cloud-builders/docker
    args: ['network', 'create', '-d', 'bridge', 'nw_zipkin']
    id: test-network
    waitFor: ['-']

  - name: gcr.io/cloud-builders/docker
    args:
    - 'run'
    - '-d'
    - '-p'
    - '9411:9411'
    - '--name=zipkin-server'
    - '--network=nw_zipkin'
    - 'openzipkin/zipkin:2.7'
    id: zipkin-server
    waitFor: ['test-network']

  - name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/test-runner', '-f', 'Dockerfile.integration',  '.']
    id: test-build
    waitFor: ['-']

  - name: gcr.io/cloud-builders/docker
    args: ['run', '--network=nw_zipkin', '-e', 'ZIPKIN_HOST=zipkin-server', 'gcr.io/$PROJECT_ID/test-runner', 'vendor/bin/phpunit', '--config=./phpunit-integration.xml.dist']
    id: test-run
    waitFor: ['test-build', 'zipkin-server']
